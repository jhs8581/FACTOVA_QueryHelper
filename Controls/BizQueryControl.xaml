<UserControl x:Class="FACTOVA_QueryHelper.Controls.BizQueryControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:converters="clr-namespace:FACTOVA_QueryHelper.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1200"
             Background="#FFF8F9FA">
    
    <UserControl.Resources>
        <converters:RowColorToBackgroundConverter x:Key="RowColorConverter"/>
    </UserControl.Resources>
    
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- 상단 그룹명 선택 영역 -->
        <Border Grid.Row="0" 
                Background="White" 
                BorderBrush="#FFE0E0E0" 
                BorderThickness="1" 
                CornerRadius="8"
                Padding="15"
                Margin="0,0,0,15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="500"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- 🔥 그룹명 선택 -->
                <TextBlock Grid.Column="0"
                           Text="📋 그룹명 선택:" 
                           FontSize="14"
                           FontWeight="SemiBold"
                           VerticalAlignment="Center"
                           Margin="0,0,10,0"/>
                
                <ComboBox x:Name="BizNameComboBox" 
                          Grid.Column="1"
                          Height="36"
                          FontSize="13"
                          VerticalContentAlignment="Center"
                          SelectionChanged="BizNameComboBox_SelectionChanged">
                    <ComboBox.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding}" 
                                       FontSize="13"
                                       Padding="5,3"/>
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                </ComboBox>
                
                <!-- 새로고침 버튼만 유지 -->
                <Button x:Name="RefreshButton" 
                        Grid.Column="3"
                        Width="120" Height="36"
                        Click="RefreshButton_Click"
                        Background="#FF0078D7" 
                        Foreground="White"
                        BorderThickness="0"
                        Cursor="Hand"
                        FontWeight="SemiBold">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="🔄" FontSize="14" Margin="0,0,5,0"/>
                        <TextBlock Text="새로고침"/>
                    </StackPanel>
                </Button>
            </Grid>
        </Border>

        <!-- 🔥 필터 영역 (신규 추가) -->
        <Border Grid.Row="1" 
                Background="#FFF8F9FA" 
                BorderBrush="#FFE0E0E0" 
                BorderThickness="1" 
                CornerRadius="8"
                Padding="15,10"
                Margin="0,0,0,15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="200"/>
                    <ColumnDefinition Width="20"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="200"/>
                    <ColumnDefinition Width="20"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="200"/>
                    <ColumnDefinition Width="20"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- 그룹명 필터 -->
                <TextBlock Grid.Column="0"
                           Text="🔍 그룹명:"
                           VerticalAlignment="Center"
                           FontWeight="SemiBold"
                           Margin="0,0,8,0"/>

                <TextBox x:Name="GroupNameFilterTextBox"
                         Grid.Column="1"
                         Height="30"
                         VerticalContentAlignment="Center"
                         BorderBrush="#FF0078D7"
                         BorderThickness="2"
                         Padding="8,4"
                         TextChanged="FilterTextBox_TextChanged"/>

                <!-- 비즈명 필터 -->
                <TextBlock Grid.Column="3"
                           Text="🔍 비즈명:"
                           VerticalAlignment="Center"
                           FontWeight="SemiBold"
                           Margin="0,0,8,0"/>

                <TextBox x:Name="BizNameFilterTextBox"
                         Grid.Column="4"
                         Height="30"
                         VerticalContentAlignment="Center"
                         BorderBrush="#FF0078D7"
                         BorderThickness="2"
                         Padding="8,4"
                         TextChanged="FilterTextBox_TextChanged"/>

                <!-- 쿼리비즈명 필터 -->
                <TextBlock Grid.Column="6"
                           Text="🔍 쿼리비즈명:"
                           VerticalAlignment="Center"
                           FontWeight="SemiBold"
                           Margin="0,0,8,0"/>

                <TextBox x:Name="QueryBizNameFilterTextBox"
                         Grid.Column="7"
                         Height="30"
                         VerticalContentAlignment="Center"
                         BorderBrush="#FF0078D7"
                         BorderThickness="2"
                         Padding="8,4"
                         TextChanged="FilterTextBox_TextChanged"/>

                <!-- 초기화 버튼 -->
                <Button x:Name="ClearFilterButton"
                        Grid.Column="9"
                        Width="100"
                        Height="30"
                        Content="✖ 초기화"
                        Click="ClearFilterButton_Click"
                        Background="#FF6C757D"
                        Foreground="White"
                        BorderThickness="0"
                        Cursor="Hand"
                        FontWeight="SemiBold"/>
            </Grid>
        </Border>

        <!-- 쿼리 목록 -->
        <Border Grid.Row="2" 
                Background="White" 
                BorderBrush="#FFE0E0E0" 
                BorderThickness="1" 
                CornerRadius="8"
                Padding="15">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <!-- 헤더 -->
                <Grid Grid.Row="0" Margin="0,0,0,10">
                    <TextBlock Text="쿼리 목록" 
                               FontSize="16" 
                               FontWeight="Bold"
                               VerticalAlignment="Center"/>
                    
                    <StackPanel Orientation="Horizontal" 
                                HorizontalAlignment="Right"
                                VerticalAlignment="Center">
                        <TextBlock Text="📊 총" 
                                   FontSize="12"
                                   Foreground="#FF6C757D"
                                   VerticalAlignment="Center"
                                   Margin="0,0,5,0"/>
                        <TextBlock x:Name="QueryCountTextBlock" 
                                   Text="0" 
                                   FontSize="14"
                                   FontWeight="Bold"
                                   Foreground="#FF0078D7"
                                   VerticalAlignment="Center"
                                   Margin="0,0,5,0"/>
                        <TextBlock Text="개" 
                                   FontSize="12"
                                   Foreground="#FF6C757D"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                </Grid>
                
                <!-- DataGrid -->
                <DataGrid x:Name="QueriesDataGrid" 
                          Grid.Row="1"
                          AutoGenerateColumns="False"
                          SelectionMode="Single"
                          SelectionChanged="QueriesDataGrid_SelectionChanged">
                    
                    <!-- 🔥 RowColor 바인딩을 위한 커스텀 RowStyle -->
                    <DataGrid.RowStyle>
                        <Style TargetType="DataGridRow">
                            <!-- 🔥 RowColor를 Background에 바인딩 (Converter 사용) -->
                            <Setter Property="Background" Value="{Binding RowColor, Converter={StaticResource RowColorConverter}}"/>
                            
                            <Style.Triggers>
                                <!-- 🔥 RowColor가 비어있을 때 Transparent -->
                                <DataTrigger Binding="{Binding RowColor}" Value="">
                                    <Setter Property="Background" Value="Transparent"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding RowColor}" Value="{x:Null}">
                                    <Setter Property="Background" Value="Transparent"/>
                                </DataTrigger>
                                
                                <!-- 마우스 오버 시 커서 변경 -->
                                <Trigger Property="AlternationIndex" Value="1">
                                    <Setter Property="Background" Value="#F5F5F5"/>
                                </Trigger>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Cursor" Value="Hand"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </DataGrid.RowStyle>
                    
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="순번" Binding="{Binding OrderNumber}" Width="80">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                    <Setter Property="FontWeight" Value="Bold"/>
                                    <Setter Property="FontSize" Value="13"/>
                                    <Setter Property="Foreground" Value="Black"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        
                        <!-- 🔥 그룹명 컬럼 - 동적으로 표시/숨김 -->
                        <DataGridTextColumn x:Name="GroupNameColumn" Header="그룹명" Binding="{Binding QueryName}" Width="Auto">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                    <Setter Property="Padding" Value="5,0"/>
                                    <Setter Property="Foreground" Value="#FF0078D7"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <DataGridTextColumn Header="비즈명" Binding="{Binding BizName}" Width="Auto">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Padding" Value="5,0"/>
                                    <Setter Property="Foreground" Value="Black"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        
                        <DataGridTextColumn Header="쿼리비즈명" Binding="{Binding QueryBizName}" Width="Auto">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Padding" Value="5,0"/>
                                    <Setter Property="Foreground" Value="Black"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        
                        <DataGridTextColumn Header="설명" Binding="{Binding Description2}" Width="*">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="TextWrapping" Value="Wrap"/>
                                    <Setter Property="Padding" Value="5,0"/>
                                    <Setter Property="Foreground" Value="Black"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <DataGridTextColumn Header="TNS" Binding="{Binding TnsName}" Width="120" Visibility="Collapsed">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Padding" Value="5,0"/>
                                    <Setter Property="Foreground" Value="Black"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <DataGridTextColumn Header="User ID" Binding="{Binding UserId}" Width="100" Visibility="Collapsed">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Padding" Value="5,0"/>
                                    <Setter Property="Foreground" Value="Black"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <DataGridTextColumn Header="Password" Binding="{Binding Password}" Width="100" Visibility="Collapsed">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Text" Value="••••••••"/>
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                    <Setter Property="Foreground" Value="#FF6C757D"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        
                        <DataGridTemplateColumn Header="쿼리 보기" Width="120">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Content="📝 쿼리 보기" 
                                            Click="ViewQueryButton_Click"
                                            Tag="{Binding}"
                                            Background="#FF28A745"
                                            Foreground="White"
                                            BorderThickness="0"
                                            Height="28"
                                            FontSize="11"
                                            FontWeight="SemiBold"
                                            Cursor="Hand"
                                            Margin="2">
                                        <Button.Style>
                                            <Style TargetType="Button">
                                                <Setter Property="Background" Value="#FF28A745"/>
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#FF218838"/>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                    </Button>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        
                        <DataGridTemplateColumn Header="쿼리 실행" Width="120">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Content="▶️ 쿼리 실행" 
                                            Click="ExecuteBizButton_Click"
                                            Tag="{Binding}"
                                            Background="#FFDC3545"
                                            Foreground="White"
                                            BorderThickness="0"
                                            Height="28"
                                            FontSize="11"
                                            FontWeight="SemiBold"
                                            Cursor="Hand"
                                            Margin="2">
                                        <Button.Style>
                                            <Style TargetType="Button">
                                                <Setter Property="Background" Value="#FFDC3545"/>
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#FFC82333"/>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                    </Button>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Border>

        <!-- 하단 상태바 -->
        <Border Grid.Row="3" 
                Background="White" 
                BorderBrush="#FFE0E0E0" 
                BorderThickness="1" 
                CornerRadius="8"
                Padding="15,10"
                Margin="0,15,0,0">
            <Grid>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="💡 " 
                               FontSize="14"
                               VerticalAlignment="Center"/>
                    
                    <TextBlock x:Name="StatusTextBlock" 
                               Text="그룹명을 선택하세요." 
                               FontSize="12"
                               Foreground="#FF6C757D"
                               VerticalAlignment="Center"
                               Margin="5,0,0,0"/>
                </StackPanel>
                
                <TextBlock HorizontalAlignment="Right"
                           VerticalAlignment="Center"
                           FontSize="11"
                           Foreground="#FF6C757D">
                    <Run Text="💡 팁:"/>
                    <Run Text="쿼리 보기 버튼을 클릭하면 SQL 쿼리를 확인할 수 있습니다."/>
                </TextBlock>
            </Grid>
        </Border>
    </Grid>
</UserControl>
